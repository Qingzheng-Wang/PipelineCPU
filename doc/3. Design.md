# 3. Design

## 3.1 总体设计

​    在本次实验中，我设计的是五级流水线CPU(带冒险控制)。流水线的各个阶段功能如下：

1. IF: 从指令存储单元中取出指令，计算PC+4。
2. ID: 根据指令进行译码，控制器根据指令产生控制信号，寄存器堆根据指令中的源寄存器号得出源寄存器的值，立即数扩展单元生成立即数。
3. EXE: 运算器进行运算，选择前递的数据，对立即数进行移位。
4. MEM: 根据运算器计算得到的地址读或写数据。
5. WB: 选择写回到寄存器里的数据。

## 3.2 PC寄存器

**3.2.1** **功能描述**

​    PC用于存储当前所需的PC的值。

**3.2.2** **模块接口**

| 信号名 | 方向   | 描述                |
| ------ | ------ | ------------------- |
| clk    | input  | 时钟信号            |
| we     | input  | 写使能信号          |
| clr    | input  | 清除信号            |
| NPC    | input  | 输入由NPC选择的PC值 |
| PC     | output | 输出当前PC值        |

## 3.3 NPC

**3.3.1** **功能描述**

​    选择要传送到PC的值。

**3.3.2****模块接口**

| 信号名  | 方向   | 描述                                     |
| ------- | ------ | ---------------------------------------- |
| NPCOp   | input  | 选择控制信号                             |
| PCPLUS4 | input  | 当前PC寄存器中的PC值加4                  |
| PC_b    | input  | PC+imm<<1, b型指令的跳转地址             |
| PC_jal  | input  | PC+imm<<1, jal指令的跳转地址             |
| PC_jalr | input  | rd+imm<<1, jalr指令的跳转地址            |
| NPC     | output | 输出到PC寄存器，作为下一个时钟周期的PC值 |

 

## 3.4 RF(寄存器堆)

**3.4.1** **功能描述**

​    存放32个32位寄存器，根据指令和控制信号完成寄存器的读写操作。

**3.4.2 模块接口**

| 信号名   | 方向   | 描述                 |
| -------- | ------ | -------------------- |
| clk      | input  | 时钟信号             |
| rst      | input  | 清空所有寄存器的值   |
| RFWr     | input  | 寄存器堆写使能信号   |
| instr_in | input  | 指令输入             |
| wregnum  | input  | 数据写入的寄存器序号 |
| WD       | input  | 写入寄存器的数据     |
| RD1      | output | 读出的寄存器数据1    |
| RD2      | output | 读出的寄存器数据2    |

## 3.5 ctrl(控制单元)

**3.5.1** **功能描述**

​    根据指令产生控制信号。

**3.5.2 模块接口**

| 信号名   | 方向   | 描述                             |
| -------- | ------ | -------------------------------- |
| instr_in | input  | 指令输入                         |
| RegWrite | output | RF写使能信号                     |
| EXTOp    | output | 立即数扩展单元控制信号           |
| ALUOp    | output | 运算器控制信号                   |
| NPCOp    | output | NPC选择控制信号                  |
| ALUSrc   | output | 运算器源操作数选择信号           |
| mem_w    | output | 数据存储单元写使能信号           |
| wea      | output | 数据存储单元写入数据类型选择信号 |
| WDSel    | output | WB阶段写回数据选择信号           |

 

## 3.6 EXT(立即数扩展单元)

**3.6.1** **功能描述**

​    根据指令产生控制信号。

**3.6.2 模块接口**

| 信号名   | 方向   | 描述                     |
| -------- | ------ | ------------------------ |
| instr_in | input  | 指令输入                 |
| EXTOp    | input  | 立即数扩展单元控制信号   |
| immout   | output | 根据指令生成的32位立即数 |

 

## 3.6 rs1_fwd_mux(前递数据选择器1)

**3.6.1** **功能描述**

​    根据冒险控制信号在rs1和前递数据中选择运算器的源操作数。

**3.6.2 模块接口**

| 信号名            | 方向   | 描述                                |
| ----------------- | ------ | ----------------------------------- |
| rs1_fwd_sel       | input  | 选择控制信号                        |
| rs1_in            | input  | rs1的值                             |
| ALU_result_Fwd    | input  | EXE_MEM寄存器中存储的运算器运算结果 |
| WriteBackData_Fwd | input  | WB阶段经选择后的写回数据            |
| ALU_A             | output | 运算器源操作数1                     |

 

## 3.7 rs2_fwd_mux(前递数据选择器2)

**3.7.1** **功能描述**

​    根据冒险控制信号在rs2和前递数据中选择运算器的源操作数。

**3.7.2 模块接口**

| 信号名            | 方向   | 描述                                |
| ----------------- | ------ | ----------------------------------- |
| rs2_fwd_sel       | input  | 选择控制信号                        |
| rs2_in            | input  | rs1的值                             |
| ALU_result_Fwd    | input  | EXE_MEM寄存器中存储的运算器运算结果 |
| WriteBackData_Fwd | input  | WB阶段经选择后的写回数据            |
| ALU_B             | output | 选择后的输出                        |

 

## 3.8 ALUSrc(运算器数据源选择器)

**3.8.1** **功能描述**

​    在rs2_fwd_mux选择的结果同立即数之中选择运算器两个源操作数当中的一个。

**3.8.2 模块接口**

| 信号名    | 方向   | 描述              |
| --------- | ------ | ----------------- |
| ALUSrc_in | input  | 选择控制信号      |
| ALU_B     | input  | rs2_fwd_mux的结果 |
| ImmGen    | input  | 立即数输入        |
| ALUSrc2   | output | 运算器源操作数    |

 

## 3.9 ALU(运算器)

**3.9.1** **功能描述**

​    运算器用于实现指令的算术逻辑运算、地址运算和分支跳转判断。

**3.9.2 模块接口**

| 信号名 | 方向   | 描述                         |
| ------ | ------ | ---------------------------- |
| A      | input  | 源操作数1                    |
| B      | input  | 源操作数2                    |
| ALUOp  | input  | 运算器控制信号               |
| PC     | input  | PC输入                       |
| C      | output | 运算器运算结果               |
| Zero   | output | 零信号，在分支跳转判断时使用 |

 

## 3.10 shift(移位运算单元)

**3.10.1** **功能描述**

​    对立即数进行移位。

**3.10.2 模块接口**

| 信号名     | 方向   | 描述       |
| ---------- | ------ | ---------- |
| ImmGen_in  | input  | 立即数输入 |
| ImmGen_out | output | 立即数输出 |

 

 

## 3.11 AND(与运算单元)

**3.11.1** **功能描述**

​    用于得到新的NPCOp信号。

**3.11.2 模块接口**

| 信号名    | 方向   | 描述          |
| --------- | ------ | ------------- |
| NPCOp_in  | input  | NPCOp输入     |
| Zero      | input  | 零信号        |
| NPCOp_new | output | 新的NPCOp信号 |

 

## 3.12 adder_branch(地址加法器)

**3.12.1** **功能描述**

​    为B型指令计算跳转地址。

**3.12.2 模块接口**

| 信号名 | 方向   | 描述           |
| ------ | ------ | -------------- |
| in0    | input  | 源操作数1      |
| in1    | input  | 源操作数2      |
| out    | output | 加法器计算结果 |



## 3.13 WB(写回数据选择器)

**3.13.1** **功能描述**

​    用于选择写回数据。

**3.13.2 模块接口**

| 信号名        | 方向   | 描述                 |
| ------------- | ------ | -------------------- |
| WDSel         | input  | 写回数据选择信号     |
| ALU_result    | input  | 运算器运算结果       |
| DM_data       | input  | 数据存储器输出的数据 |
| PCPLUS4       | input  | PC加4                |
| WriteBackData | output | 写回数据             |



## 3.14 HazardCtrl(冒险控制单元)

**3.14.1** **功能描述**

​    根据指令产生冒险控制信号。

**3.14.2 模块接口**

| 信号名        | 方向   | 描述                                        |
| ------------- | ------ | ------------------------------------------- |
| instr_in      | input  | 指令输入                                    |
| RegWrite_EXE  | input  | EXE阶段的RegWrite信号                       |
| wregnum_EXE   | input  | EXE阶段的wregnum                            |
| NPCOp_new_EXE | input  | EXE阶段新生成的NPCOp信号                    |
| WDSel_EXE     | input  | EXE阶段的WDSel信号                          |
| RegWrite_MEM  | input  | EXE阶段的RegWrite信号                       |
| wregnum_MEM   | input  | MEM阶段的wregnum信号                        |
| stall         | output | 停止信号，使PC寄存器和IF_ID寄存器停止写数据 |
| rs1_fwd_sel   | output | 前递数据选择器1选择控制信号                 |
| rs2_fwd_sel   | output | 前递数据选择器2选择控制信号                 |
| Flush_IF_ID   | output | IF_ID寄存器清空信号                         |
| Flush_ID_EXE  | output | ID_EXE寄存器清空信号                        |